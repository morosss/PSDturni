<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSDturni - Sistema Gestione Turni Ospedalieri</title>
    <link rel="icon" type="image/jpeg" href="icon.jpg">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="hospital-logo">
                    <img src="logo.jpg" alt="Hospital Logo" style="max-width: 200px; height: auto; border-radius: 8px;">
                </div>
                <h1>PSDturni</h1>
                <p class="subtitle">Sistema Gestione Turni</p>

                <form id="loginForm" class="form">
                    <div class="input-group">
                        <label for="userId">ID Utente</label>
                        <input type="text" id="userId" placeholder="es. mrossi" required autocomplete="username">
                        <span class="helper-text">Formato: inizialenome+cognome</span>
                    </div>

                    <div class="input-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required autocomplete="current-password">
                    </div>

                    <div class="input-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            <span>Ricorda le mie credenziali</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span class="material-icons">login</span>
                        Accedi
                    </button>

                    <div id="loginError" class="error-message"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- First Login - Change Password -->
    <div id="firstLoginScreen" class="screen">
        <div class="login-container">
            <div class="login-card">
                <h2>Primo Accesso</h2>
                <p>Imposta la tua password personale</p>

                <form id="firstLoginForm" class="form">
                    <div class="input-group">
                        <label for="newPassword">Nuova Password</label>
                        <input type="password" id="newPassword" required minlength="6">
                    </div>

                    <div class="input-group">
                        <label for="confirmPassword">Conferma Password</label>
                        <input type="password" id="confirmPassword" required minlength="6">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        Imposta Password
                    </button>

                    <div id="firstLoginError" class="error-message"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardScreen" class="screen">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <img src="icon.jpg" class="logo-icon" alt="Hospital Logo" style="width: 32px; height: 32px; border-radius: 4px;">
                    <h1>PSDturni</h1>
                </div>
                <div class="header-right">
                    <span id="currentUserName" class="user-name"></span>
                    <button id="changePasswordBtn" class="btn btn-icon" title="Cambia Password">
                        <span class="material-icons">lock</span>
                    </button>
                    <button id="logoutBtn" class="btn btn-icon" title="Logout">
                        <span class="material-icons">logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation" id="mainNav">
            <button class="nav-btn active" data-view="calendar">
                <span class="material-icons">calendar_today</span>
                <span>Calendario</span>
            </button>
            <button class="nav-btn" data-view="availability" id="availabilityNavBtn">
                <span class="material-icons">event_busy</span>
                <span>Indisponibilità</span>
            </button>
            <button class="nav-btn admin-only" data-view="users" style="display: none;">
                <span class="material-icons">people</span>
                <span>Utenti</span>
            </button>
            <button class="nav-btn admin-only" data-view="shifts" style="display: none;">
                <span class="material-icons">schedule</span>
                <span>Gestione Turni</span>
            </button>
            <button class="nav-btn admin-only" data-view="autoassign" style="display: none;">
                <span class="material-icons">auto_fix_high</span>
                <span>Assegnazione Automatica</span>
            </button>
            <button class="nav-btn admin-only" data-view="availability-overview" style="display: none;">
                <span class="material-icons">grid_on</span>
                <span>Panoramica Indisponibilità</span>
            </button>
            <button class="nav-btn admin-only" data-view="versions" style="display: none;">
                <span class="material-icons">history</span>
                <span>Versioni</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Calendar View -->
            <div id="calendarView" class="view active">
                <div class="view-header">
                    <h2>Calendario Turni</h2>
                    <div class="view-actions">
                        <button id="exportPdfBtn" class="btn btn-secondary admin-only" style="display: none;">
                            <span class="material-icons">picture_as_pdf</span>
                            Esporta PDF
                        </button>
                        <button id="exportExcelBtn" class="btn btn-secondary admin-only" style="display: none;">
                            <span class="material-icons">table_chart</span>
                            Esporta Excel
                        </button>
                    </div>
                </div>

                <div class="calendar-controls">
                    <button id="prevMonth" class="btn btn-icon">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <div class="month-header-container">
                        <h3 id="currentMonth"></h3>
                        <div id="approvalBadge" class="approval-badge"></div>
                    </div>
                    <button id="nextMonth" class="btn btn-icon">
                        <span class="material-icons">chevron_right</span>
                    </button>
                    <button id="toggleApprovalBtn" class="btn btn-secondary admin-only" style="display: none;">
                        <span class="material-icons">check_circle</span>
                        <span id="approvalBtnText">Segna come Definitivo</span>
                    </button>
                </div>

                <div id="calendarGrid" class="calendar-grid"></div>
            </div>

            <!-- Availability View -->
            <div id="availabilityView" class="view">
                <div class="view-header">
                    <h2>Gestione Indisponibilità</h2>
                    <div id="deadlineWarning" class="warning-box"></div>
                </div>

                <div class="availability-controls">
                    <div class="month-selector">
                        <label>Seleziona Mese:</label>
                        <select id="availabilityMonth"></select>
                    </div>
                </div>

                <div id="availabilityCalendar" class="availability-calendar"></div>

                <div class="form-actions">
                    <button id="saveAvailability" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salva Indisponibilità
                    </button>
                </div>
            </div>

            <!-- Users Management View (Admin Only) -->
            <div id="usersView" class="view">
                <div class="view-header">
                    <h2>Gestione Utenti</h2>
                    <button id="addUserBtn" class="btn btn-primary">
                        <span class="material-icons">person_add</span>
                        Aggiungi Utente
                    </button>
                </div>

                <div class="users-grid" id="usersGrid"></div>
            </div>

            <!-- Shifts Management View (Admin Only) -->
            <div id="shiftsView" class="view">
                <div class="view-header">
                    <h2>Gestione Turni</h2>
                    <div class="view-actions">
                        <button class="btn btn-secondary" onclick="openManageColumnsModal()">
                            <span class="material-icons">view_column</span>
                            Gestisci Colonne
                        </button>
                        <select id="shiftMonth" class="select-input"></select>
                    </div>
                </div>

                <div id="shiftsGrid" class="shifts-grid"></div>
            </div>

            <!-- Auto Assignment View (Admin Only) -->
            <div id="autoassignView" class="view">
                <div class="view-header">
                    <h2>Assegnazione Automatica Turni</h2>
                    <p class="view-subtitle">Genera turni in modo intelligente con bilanciamento automatico</p>
                </div>

                <div class="auto-assign-container">
                    <!-- Configuration Card -->
                    <div class="config-card">
                        <div class="card-header">
                            <span class="material-icons">settings</span>
                            <h3>Configurazione</h3>
                        </div>
                        <div class="card-content">
                            <div class="input-group">
                                <label>Mese da Generare</label>
                                <select id="autoAssignMonth" class="select-input"></select>
                            </div>

                            <div class="input-group">
                                <label>Modalità Generazione</label>
                                <div class="radio-group-cards">
                                    <label class="radio-card">
                                        <input type="radio" name="assignMode" value="all" checked>
                                        <div class="radio-card-content">
                                            <span class="material-icons">refresh</span>
                                            <div>
                                                <strong>Tutti i turni</strong>
                                                <small>Rigenera completamente il mese</small>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="radio-card">
                                        <input type="radio" name="assignMode" value="remaining">
                                        <div class="radio-card-content">
                                            <span class="material-icons">playlist_add</span>
                                            <div>
                                                <strong>Solo slot vuoti</strong>
                                                <small>Riempie solo gli slot mancanti</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shift Types Selection Card -->
                    <div class="config-card">
                        <div class="card-header">
                            <span class="material-icons">list_alt</span>
                            <h3>Tipologie Turni</h3>
                        </div>
                        <div class="card-content">
                            <div class="shift-type-grid">
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignSALA" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">local_hospital</span>
                                        <div class="shift-type-info">
                                            <strong>SALA</strong>
                                            <small>Senior + Junior</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignREPARTO" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">hotel</span>
                                        <div class="shift-type-info">
                                            <strong>REPARTO</strong>
                                            <small>REPARTO</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignUTICPS" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">emergency</span>
                                        <div class="shift-type-info">
                                            <strong>UTIC/PS</strong>
                                            <small>UTIC, PS</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignRAP" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">phone_in_talk</span>
                                        <div class="shift-type-info">
                                            <strong>Reperibilità</strong>
                                            <small>RAP (Emodinamisti)</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignECO" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">favorite</span>
                                        <div class="shift-type-info">
                                            <strong>ECO</strong>
                                            <small>206, 204, INT</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignVISITE" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">assignment</span>
                                        <div class="shift-type-info">
                                            <strong>VISITE</strong>
                                            <small>201, 208, TDS 207</small>
                                        </div>
                                    </div>
                                </label>
                                <label class="shift-type-card">
                                    <input type="checkbox" id="assignOthers" checked>
                                    <div class="shift-type-content">
                                        <span class="material-icons">more_horiz</span>
                                        <div class="shift-type-info">
                                            <strong>Altri</strong>
                                            <small>ENI, ECOTT, CARDIOCHIR, ecc.</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options Card (Collapsible) -->
                    <div class="config-card">
                        <div class="card-header clickable" onclick="toggleAdvancedOptions()">
                            <span class="material-icons">tune</span>
                            <h3>Opzioni Avanzate</h3>
                            <span class="material-icons expand-icon" id="advancedExpandIcon">expand_more</span>
                        </div>
                        <div class="card-content" id="advancedOptionsContent" style="display: none;">
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="respectUserLimits" checked>
                                    <span>Rispetta limiti mensili utenti</span>
                                </label>
                                <small class="helper-text">Se attivo, rispetta i limiti min/max configurati per ogni utente</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="balanceAmbulatori" checked>
                                    <span>Bilanciamento per ambulatorio</span>
                                </label>
                                <small class="helper-text">Distribuisce equamente i turni per ogni ambulatorio</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="respectUnavailability" checked>
                                    <span>Rispetta indisponibilità</span>
                                </label>
                                <small class="helper-text">Evita di assegnare turni a utenti non disponibili</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="avoidConsecutiveNights" checked>
                                    <span>Evita notti consecutive</span>
                                </label>
                                <small class="helper-text">Non assegna turni di notte consecutivi allo stesso utente</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enforceREPRule" checked>
                                    <span>Applica regola REP per turni notturni</span>
                                </label>
                                <small class="helper-text">Assicura che i turni notturni abbiano emodinamisti REP-capable</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="weekendContinuity" checked>
                                    <span>Continuità emodinamista weekend</span>
                                </label>
                                <small class="helper-text">Mantiene lo stesso emodinamista per tutto il weekend</small>
                            </div>
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="balanceWeekendShifts">
                                    <span>Bilancia turni weekend</span>
                                </label>
                                <small class="helper-text">Distribuisce equamente i turni nei weekend tra gli utenti</small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button id="runAutoAssignPreview" class="btn btn-secondary btn-lg">
                            <span class="material-icons">visibility</span>
                            Anteprima Generazione
                        </button>
                        <button id="runAutoAssign" class="btn btn-primary btn-lg">
                            <span class="material-icons">auto_fix_high</span>
                            Genera Turni
                        </button>
                    </div>

                    <!-- Progress Indicator -->
                    <div id="autoAssignProgress" class="progress-container" style="display: none;">
                        <div class="progress-content">
                            <div class="spinner"></div>
                            <div class="progress-text">
                                <h4>Generazione in corso...</h4>
                                <p id="progressMessage">Analisi delle disponibilità...</p>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="autoAssignResults" class="auto-assign-results"></div>
                </div>
            </div>

            <!-- Availability Overview View (Admin Only) -->
            <div id="availability-overviewView" class="view">
                <div class="view-header">
                    <h2>Panoramica Indisponibilità</h2>
                    <div class="view-actions">
                        <select id="availabilityOverviewMonth" class="select-input"></select>
                        <button id="exportAvailabilityPdfBtn" class="btn btn-secondary">
                            <span class="material-icons">picture_as_pdf</span>
                            Esporta PDF
                        </button>
                        <button id="exportAvailabilityExcelBtn" class="btn btn-secondary">
                            <span class="material-icons">table_chart</span>
                            Esporta Excel
                        </button>
                    </div>
                </div>

                <div id="availabilityOverviewGrid" class="availability-overview-grid"></div>
            </div>

            <!-- Versions Management View (Admin Only) -->
            <div id="versionsView" class="view">
                <div class="view-header">
                    <h2>Gestione Versioni Turni</h2>
                    <button id="saveVersionBtn" class="btn btn-primary">
                        <span class="material-icons">save</span>
                        Salva Versione Corrente
                    </button>
                </div>

                <div class="version-controls">
                    <div class="input-group">
                        <label>Mese:</label>
                        <select id="versionMonth"></select>
                    </div>
                </div>

                <div id="versionsGrid" class="versions-grid"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cambia Password</h3>
                <button type="button" class="modal-close" data-modal="changePasswordModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="changePasswordForm" class="form">
                <div class="input-group">
                    <label for="currentPassword">Password Attuale</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="input-group">
                    <label for="newPasswordChange">Nuova Password</label>
                    <input type="password" id="newPasswordChange" required minlength="6">
                </div>
                <div class="input-group">
                    <label for="confirmPasswordChange">Conferma Nuova Password</label>
                    <input type="password" id="confirmPasswordChange" required minlength="6">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="changePasswordModal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Cambia Password</button>
                </div>
                <div id="changePasswordError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="userModalTitle">Aggiungi Utente</h3>
                <button type="button" class="modal-close" data-modal="userModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="userForm" class="form">
                <div class="input-group">
                    <label for="userName">Nome Completo</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="input-group">
                    <label for="userCode">Nickname / Codice</label>
                    <input type="text" id="userCode" maxlength="10" placeholder="es. PIZ, GAS, MARTO">
                    <span class="helper-text">Codice breve visualizzato nel calendario (max 10 caratteri)</span>
                </div>
                <div class="input-group">
                    <label for="userIdInput">ID Utente</label>
                    <input type="text" id="userIdInput" required pattern="[a-z]+">
                    <span class="helper-text">Formato: inizialenome+cognome (es. mrossi)</span>
                </div>
                <div class="input-group">
                    <label for="userRole">Ruolo</label>
                    <select id="userRole" required>
                        <option value="user">Utente</option>
                        <option value="admin">Amministratore</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userSpecialty">Specialità</label>
                    <input type="text" id="userSpecialty" placeholder="es. Emodinamista, Ecocardiografista">
                </div>
                <div class="input-group">
                    <label for="userEmail">Email (opzionale)</label>
                    <input type="email" id="userEmail" placeholder="es. nome.cognome@ospedale.it">
                </div>
                <div class="input-group">
                    <label>Turni Abilitati</label>
                    <div id="shiftCapabilities" class="checkbox-grid"></div>
                </div>
                <div class="input-group">
                    <label>Limiti Mensili Turni (opzionale)</label>
                    <span class="helper-text">Imposta il numero minimo e massimo di turni al mese per ogni tipo</span>
                    <div id="shiftLimits" class="limits-grid"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="userModal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
                <div id="userFormError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exportModalTitle">Esporta</h3>
                <button type="button" class="modal-close" data-modal="pdfModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="pdfForm" class="form">
                <div class="input-group">
                    <label for="pdfMonth">Mese</label>
                    <select id="pdfMonth"></select>
                </div>
                <div class="input-group">
                    <label>Tipo</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="pdfType" value="draft" checked>
                            <span>Bozza</span>
                        </label>
                        <label>
                            <input type="radio" name="pdfType" value="final">
                            <span>Definitivo</span>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="pdfModal">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="exportSubmitBtn">
                        <span class="material-icons">download</span>
                        <span id="exportSubmitText">Scarica</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Columns Modal -->
    <div id="manageColumnsModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Gestione Colonne Turni</h3>
                <button type="button" class="modal-close" data-modal="manageColumnsModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="form">
                <div class="info-box">
                    <span class="material-icons">info</span>
                    <p>Aggiungi nuove colonne (turni) personalizzate. Le colonne predefinite non possono essere eliminate.</p>
                </div>

                <h4>Colonne Personalizzate</h4>
                <div id="customColumnsList"></div>

                <h4 style="margin-top: 20px;">Aggiungi Nuova Colonna</h4>
                <div class="input-group">
                    <label for="newColumnName">Nome Turno</label>
                    <input type="text" id="newColumnName" placeholder="es. NUOVA SEDE, TURNO SPECIALE">
                </div>
                <div class="input-group">
                    <label for="newColumnSlots">Slot (separati da virgola)</label>
                    <input type="text" id="newColumnSlots" placeholder="es. MATT, POM, NTT">
                    <span class="helper-text">Usa MATT (mattina), POM (pomeriggio), NTT (notte), GG (giornata), SPEC (speciale), o slot personalizzati</span>
                </div>
                <button type="button" class="btn btn-primary" onclick="addCustomColumn()">
                    <span class="material-icons">add</span>
                    Aggiungi Colonna
                </button>

                <div class="modal-actions" style="margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" data-modal="manageColumnsModal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Version Modal -->
    <div id="saveVersionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Salva Versione Turni</h3>
                <button type="button" class="modal-close" data-modal="saveVersionModal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="saveVersionForm" class="form">
                <div class="input-group">
                    <label for="versionName">Nome Versione</label>
                    <input type="text" id="versionName" required placeholder="es. Versione 1, Bozza Novembre, ecc.">
                </div>
                <div class="input-group">
                    <label for="versionMonthSelect">Mese</label>
                    <select id="versionMonthSelect" required></select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-modal="saveVersionModal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Versione</button>
                </div>
                <div id="saveVersionError" class="error-message"></div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
